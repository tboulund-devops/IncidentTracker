name: ci

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
        
  jobs:
    # CLIENT
    client-checks:
      name: Client Install and Check
      runs-on: ubuntu-latest
        
        
      steps:
          - uses: actions/checkout@v4
          
          - uses: actions/setup-node@v4
            with:
              node-version: '24'
              cache: 'npm'
              cache-dependency-path: client/package-lock.json
              
          - name: npm install
            working-directory: client
            run: npm ci
            
          - name: Typecheck
            working-directory: client
            run: npm run lint --if-present
            
      client-test:
        name: Client Test
        runs-on: ubuntu-latest
        needs: client-checks
          
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
              node-version: '24'
              cache: 'npm'
              cache-dependency-path: client/package-lock.json
            
            
          - working-directory: client
            run: npm ci
            
          - working-directory: client
            run: npm run test --if-present
            
      client-build:
        name: Client Build
        runs-on: ubuntu-latest
        needs: client-checks
          
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
              node-version: '24'
              cache: 'npm'
              cache-dependency-path: client/package-lock.json
              
              
          - working-directory: client
            run: npm ci
            
          - working-directory: client
            run: npm run build --if-present
            
    # SERVER        
    server-build:
      name: Server Build
      runs-on: ubuntu-latest
      needs: client-checks
        
      steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-dotnet@v4
            with:
              dotnet-version: '10.0.x'
              
              
          - name: Restore
            working-directory: server
            run: dotnet restore
            
          - name: Build
            working-directory: server
            run: dotnet build --configuration Release --no-restore
            
            
    server-test:
      name: Server Test
      runs-on: ubuntu-latest
      needs: server-build
      
      #services:
      #  docker:
      #    image: docker:dind
        
      steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-dotnet@v4
            with:
              dotnet-version: '10.0.x'
              
          #- name: Ensure Docker is running
          #  run: docker ps
          
          - name: Run Tests
            working-directory: server
            run: dotnet test -c Release --no-build